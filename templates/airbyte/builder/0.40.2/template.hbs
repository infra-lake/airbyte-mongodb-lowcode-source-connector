version: 0.40.2
type: DeclarativeSource
check:
  type: CheckStream
  stream_names:
    {{#each streams}}
    - {{ this.name }}
    {{/each}}
streams:
{{#each streams}}
  - type: DeclarativeStream
    name: {{ this.name }}
    primary_key:
      - {{ ../stamps.id }}
    schema_loader:
      type: InlineSchemaLoader
      schema:
        "$schema": https://json-schema.org/draft/2019-09/schema
        additionalProperties: true
        properties:
          {{ ../stamps.id }}:
            type: string
          {{ ../stamps.insert }}:
            type: string
          {{ ../stamps.update }}:
            type: string
        type: object
    retriever:
      type: SimpleRetriever
      requester:
        type: HttpRequester
        url_base: http://mongodb-exporter-service:4000
        path: /export/{{ this.database }}/{{ this.name }}
        http_method: GET
        request_parameters:
          mode: page
          sort[{{ ../stamps.insert }}]: asc
        request_headers: {}
        authenticator:
          type: BasicHttpAuthenticator
          password: {{ airbyteConfig "password" }}
          username: {{ airbyteConfig "username" }}
        error_handler:
          type: CompositeErrorHandler
          error_handlers:
            - type: DefaultErrorHandler
              backoff_strategies:
                - type: WaitTimeFromHeader
                  header: Retry-After
        request_body_json: {}
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path:
            - results
      paginator:
        type: DefaultPaginator
        page_token_option:
          type: RequestOption
          inject_into: request_parameter
          field_name: page
        page_size_option:
          type: RequestOption
          field_name: limit
          inject_into: request_parameter
        pagination_strategy:
          type: PageIncrement
          page_size: {{ ../stamps.limit }}
          start_from_page: 0
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: {{ ../stamps.update }}
      datetime_format: '%Y-%m-%dT%H:%M:%S.000Z'
      end_time_option:
        type: RequestOption
        field_name: __window[end]
        inject_into: request_parameter
      start_time_option:
        type: RequestOption
        field_name: __window[begin]
        inject_into: request_parameter
      cursor_granularity: PT1S
      start_datetime:
        type: MinMaxDatetime
        datetime: {{ airbyteConfig "start_date" }}
        datetime_format: '%Y-%m-%dT%H:%M:%SZ'
      end_datetime:
        type: MinMaxDatetime
        datetime: {{ airbyteNow }}
        datetime_format: '%Y-%m-%dT%H:%M:%SZ'
      step: P1000Y
{{/each}}
spec:
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    type: object
    required:
      - start_date
      - username
    properties:
      start_date:
        type: string
        title: Start date
        format: date-time
        pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$
        order: 0
      username:
        type: string
        title: username
        order: 1
      password:
        type: string
        title: password
        always_show: true
        airbyte_secret: true
        order: 2
    additionalProperties: true
  documentation_url: https://example.org
  type: Spec
  